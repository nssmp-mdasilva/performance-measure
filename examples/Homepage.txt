@inject Microsoft.Extensions.Options.IOptions<EnvironmentConfig> EnvironmentConfig
@using System.Text.RegularExpressions
@using Microsoft.AspNetCore.Http;
@using System.Globalization;
@using sportsbookreview_core_web.Helpers
@using sportsbookreview_core_web.Models.View;
@using sportsbookreview_core_web.Helpers.Schema;
@model BettingPageViewModel<CommercialContentViewModel>

@{
    Layout = "~/Views/Layout/_LayoutSBR.cshtml";
    var config = EnvironmentConfig.Value;
    var homePage = Model.Content;

    var toplist = homePage.Sections.OfType<ToplistViewModel>().FirstOrDefault();
    var sportsbooks = toplist.Sportsbooks.Where(x => x.Playbook is not null).ToList();
    var hero = homePage.Sections.OfType<HeroLayoutViewModel>().FirstOrDefault();
    var blocks = homePage.Sections.OfType<BlockContentViewModel>().ToList();
    var recentNews = homePage.Sections.OfType<RecentNewsViewModel>().Where(x => !x.Header.Contains("Promos")).SingleOrDefault();
    var promoArticles = homePage.Sections.OfType<RecentNewsViewModel>().Where(x => x.Header.Contains("Promos")).SingleOrDefault();
    var faqList = homePage.Faqs;

    //Check hero style should be used
    var todaysDate = DateTime.Now;
    var useHero = true;
    string srcLarge = "";
    string srcSmall = "";

    string getUrlSlug(string slug, RegionViewModel region)
    {
        var urlSlug = (string)(ViewData[slug] ?? region?.Slug);
        return !string.IsNullOrWhiteSpace(urlSlug) && urlSlug != "us" ? '-' + urlSlug : "";
    }

    RegionViewModel region = null;
    if (ViewBag.Region != null)
    {
        region = (RegionViewModel)ViewBag.Region;
    }
    var urlSlug = !string.IsNullOrWhiteSpace(region?.Slug) && region?.Slug != "us" ? '-' + region.Slug : "";

    var bestSportsbooksSlug = getUrlSlug("best-sportsbooks", region);
    var bettingSitesSlug = getUrlSlug("betting-sites", region);
    var bonusesSlug = getUrlSlug("bonuses", region);
    var compactToplistHeading = "Featured Online Sportsbooks";
    var headline = hero is not null ? !string.IsNullOrEmpty(hero?.Title) ? hero?.Title : "" : "";

    ViewData["type"] = "slider";
}
@section inline {
    @Html.Raw(InlineStyle.GetInlineStyle("homePageInline.css"))
}

@section schema {
    <script type="application/ld+json">
        {
            "@@context": "https://schema.org",
            "@@type": "WebPage",
            "@@id": "@(config.Url)/#webpage",
            "@@url": "@(config.Url)/",
            "name": "@(homePage.MetaTitle is not null ? homePage.MetaTitle : "No Meta Title")",
            "datePublished": "@(homePage.PublishedDate.ToString("s", CultureInfo.InvariantCulture))",
            "dateModified": "@(homePage.UpdatedDate.ToString("s", CultureInfo.InvariantCulture))",
            "description": "@(homePage.MetaDescription is not null ? homePage.MetaDescription : "No Meta Description")",
            "inLanguage": "en-US",
            "headline": "@(headline)"
        }
    </script>
    @if (homePage.Faqs is not null)
    {
        <script type="application/ld+json">
            {
                "@@context": "https://schema.org",
                "@@type":"FAQPage",
                "mainEntity": @Json.Serialize(homePage.Faqs.ToSchema())
            }
        </script>        
    }
}

@section styles {
    <link rel="preload" href="~/css/homePage.css" as="style" onload="this.onload=null;this.rel='stylesheet'"  asp-append-version="true">
    <noscript><link type="text/css" rel="stylesheet" href="~/css/homePage.css" asp-append-version="true"></noscript>
}


<environment names="Development">
    <script>const perfVar = []</script>
</environment>
<div data-region="@region.XRegionCode.ToLower()" class="home-page">
    <script>performance.mark('heroStart')</script>
    @if (hero is not null && useHero == true)
    {
        <div id="hero-container" class="bg-bright_blue">
            <div class="container">
                <div class="row align-items-center">
                    <div class="hero-banner_content col-12 col-sm-8 col-md-8 col-lg-7 col-xl-6 position-relative" style="z-index:100">
                        <div class="h1 mb-3 text-white"><span class="@hero.HeaderStyle">@hero.Title</span></div>
                        <div class="@hero.TextStyle col-7 col-md-8 col-lg-11 p-0 mb-3 text-white">@hero.SubHeading</div>
                        <div class="row pt-2 pt-lg-3">
                            @foreach (var btns in hero.Buttons)
                            {
                                if (!string.IsNullOrEmpty(@btns.SecondHalf) && !string.IsNullOrEmpty(@btns.SecondHalf))
                                {
                                    <div class="col-6 col-xl-5 pe-2">
                                        <a href="@btns.URL" class="btn @btns.Style d-flex align-items-center justify-content-center mt-0" data-aatracker="Homepage - Hero - @btns.AATracker">
                                            @(!string.IsNullOrEmpty(btns.FirstHalf) ? Html.Raw(@$"<span class='d-none d-md-inline-block me-1'>{btns.FirstHalf}</span> ") : "") @btns.SecondHalf <span class="ms-2 d-inline-block mat-icon-arrow-right-alt @(btns.Style.Contains("outline") ? "" : "icon-white") mat-icon-size-16"></span>
                                        </a>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                </div>
            </div>
            @{
                srcLarge = @hero.DeskTopImage is not null ? $"{@config.CDNUrl}{@config.CDNFolder}/{@hero.DeskTopImage.FileName}?fm=tiff&auto=compress,format" : "";
                srcSmall = @hero.MobileImage is not null ? $"{config.CDNUrl}{config.CDNFolder}/{@hero.MobileImage.FileName}?fm=tiff&auto=compress,format" : "";

            }
            <picture>
                <source media="(max-width: 719px)" srcset="@srcSmall">
                <img element-timing="hero-timing" loading="lazy" decoding="async" id="hero-img" src="@srcLarge" alt="@(!string.IsNullOrEmpty(hero.DeskTopImage.Alt) ? hero.DeskTopImage.Alt : hero.DeskTopImage.Title)">
            </picture>

        </div>
        
    } else
    {
        <div id="section-hero" class="hero-banner bg-dark">
            <div class="container">
                <div class="row">
                    <div class="hero-banner_content col-lg-7 mt-lg-4">
                        <div class="h1 text-uppercase"><span class="display-2">@Html.Raw(homePage.Subheading)</span></div>
                        @if (homePage.IntroJson is not null)
                        {
                            @Html.Raw(homePage.Intro)
                        }
                    </div>
                    @if (homePage.FeatureImage is not null)
                    {
                        Decimal aspectRatio = Convert.ToDecimal(homePage.FeatureImage.Height) / Convert.ToDecimal(homePage.FeatureImage.Width);
                        Decimal imageSmall = Math.Ceiling(aspectRatio * 380);
                        Decimal imageMedium = Math.Ceiling(aspectRatio * 560);

                        <div class="hero-banner_image col-lg-5">
                            <picture>
                                <source media="(min-width: 768px)" srcset="@(config.CDNUrl)@(config.CDNFolder)/@(homePage.FeatureImage.FileName)?fm=webp&auto=format&auto=compress&w=379&h=456&fit=crop" width="379" height="456">
                                <source media="(min-width: 576px)" srcset="@(config.CDNUrl)@(config.CDNFolder)/@(homePage.FeatureImage.FileName)?fm=webp&auto=format&auto=compress&w=560&h=@(imageMedium)&fit=crop" width="560" height="@(imageMedium)">
                                <source media="(max-width: 575.98px)" srcset="@(config.CDNUrl)@(config.CDNFolder)/@(homePage.FeatureImage.FileName)?fm=webp&auto=format&auto=compress&w=380&h=@(imageSmall)&fit=crop" width="380" height="@(imageSmall)">
                                <img loading="lazy" class="lazy" data-src="@(config.CDNUrl)@(config.CDNFolder)/@(homePage.FeatureImage.FileName)?fm=webp&auto=format&auto=compress&w=150&h=150&fit=crop" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" width="150" height="150" style="width: auto; height: auto;" alt="@((homePage.FeatureImage.Alt is not null) ? homePage.FeatureImage.Alt : homePage.FeatureImage.Title)">
                            </picture>
                        </div>
                    }
                </div>
            </div>
        </div>
        <environment names="Development">
        <script>
            performance.mark('heroEnd')
            const val = performance.measure('hero', 'heroStart', 'heroEnd');
            perfVar.push(val.duration);
            console.log('perfVar');
            console.log(val.duration);
            localStorage.setItem("myPer", [1, 2]);

        </script>
        </environment>
    }
    
    @if (sportsbooks is not null)
    {
       <div id="top-sportsbooks" class="container">
            <partial name="../Components/Commercial/ToplistStyle/HybridStyle/HybridStyleList" model="new ReusableTopListViewModel(toplist.TopListHeader, false, sportsbooks.Take(5).ToList())" />
            <div class="text-center">
                <a href="/best-sportsbooks@(urlSlug)/" class="btn btn-primary mb-5">See all Sportsbooks</a>
            </div>
       </div> 
    }
    
    @if (region?.Slug == "ontario")
    {
        <div class="container mb-4 border-top pt-3">
            @Html.Raw(region.getAffiliateDisclosure("white", false, true, true, false))
        </div>
    }
    else
    {
        <div class="container mb-4 border-top pt-3">
            @Html.Raw(region.getAffiliateDisclosure("white", false, true, true, false))
        </div>
    }

    @*
    @section bodyContent {
        <div class="content-section pb-4">

            


            <!-- FAQ List -->
            <div class="sbr-fullWidth-sectionWrapper pb-3">
                <div class="container">
                    <div class="row">
                        <div class="col-12">
                            <partial name="../Components/faqSection" model="faqList" />
                        </div>
                    </div>
                </div>
            </div>

        </div>
    }
    *@

    <section class="content-section bg-dark pt-3 pb-0 pb-lg-8 pb-xl-8">
        <div class="container">
            <div class="row justify-content-between">
                <h1 class="text-center">@Html.Raw(homePage.Title)</h1>
                <div class="col-lg-7 my-3">
                    @foreach (BlockContentViewModel block in blocks)
                    {
                        <partial name="../Components/ContentStyle/contentSection" model="block" />
                    }
                </div>
                @*@<h2 class="text-center">@Html.Raw(homePage.Subheading)</h2>
                <div class="col-lg-7 my-3">
                    @Html.Raw(content)
                </div> *@
                @if (homePage.Sidebar is not null)
                {
                    <div class="col-lg-3 my-0 my-lg-3">
                        <div class="sidebar-wrapper bg-darker p-5">
                         @foreach (var brick in homePage.Sidebar.Bricks)
                         {
                             <div class="sidebar-bricks">
                                @Html.Raw(brick.Code)
                            </div>
                         }
                         </div>
                    </div>
                }
            </div>
        </div>
    </section>

    @if (recentNews is not null)
    {
        <div class="container mt-2">
            <partial name="../Components/EditorialContent/tagArticlesSlider" model="recentNews.RelatedArticles" view-data="ViewData" />
        </div>

        @if (region?.Slug != "ontario" && promoArticles is not null)
        {
            ViewData["recentArticlesTitle"] = "More Sportsbook Promos";

            <div class="container mt-2">
                <partial name="../Components/EditorialContent/tagArticlesSlider" model="promoArticles.RelatedArticles" view-data="ViewData" />
            </div>
        }
    }


    <div class="container">
        <div class="row linkBlocks">
            <div class="@(@region?.Slug != "ontario" ? "col-lg-3" : "col-lg-4") linkBlocks-item mb-2 mb-lg-0 mb-xl-0">
                <a class="homepage-link-block bg-lighter d-block p-5 rounded-1 animate animate-icon-forward" href="/best-sportsbooks@(bestSportsbooksSlug)/">
                    <img loading="lazy" decoding="async" class="lazy" data-src="https://img.sportsbookreview.com/images/icons/star_border.svg" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="" width="64" height="64">
                    <h3 class="mt-4 d-flex justify-content-between align-items-end">Best <br class="d-sm-none d-md-none d-lg-block">Sportsbooks <span class="mat-icon-arrow-right-alt"></span></h3>
                </a>
            </div>
            <div class="@(@region?.Slug != "ontario" ? "col-lg-3" : "col-lg-4") linkBlocks-item mb-2 mb-lg-0 mb-xl-0">
                <a class="homepage-link-block bg-lighter d-block p-5 rounded-1 animate animate-icon-forward" href="/betting-sites@(region?.Slug != "ontario" ? bettingSitesSlug : "-canada")/">
                    <img loading="lazy" decoding="async" class="lazy" data-src="https://img.sportsbookreview.com/images/icons/monetization_on.svg" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="" width="64" height="64">
                    <h3 class="mt-4 d-flex justify-content-between align-items-end">Betting Sites <br class="d-sm-none d-md-none d-lg-block">Reviewed <span class="mat-icon-arrow-right-alt"></span></h3>
                </a>
            </div>
           <div class="@(@region?.Slug != "ontario" ? "col-lg-3" : "col-lg-4") linkBlocks-item mb-2 mb-lg-0 mb-xl-0">
                <a class="homepage-link-block bg-lighter d-block p-5 rounded-1 animate animate-icon-forward" href="/betting-calculators/">
                    <img loading="lazy" decoding="async" class="lazy" data-src="https://img.sportsbookreview.com/images/icons/calculate.svg" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="" width="64" height="64">
                    <h3 class="mt-4 d-flex justify-content-between align-items-end">Betting <br class="d-sm-none d-md-none d-lg-block">Calculators <span class="mat-icon-arrow-right-alt"></span></h3>
                </a>
            </div>
            @if (@region?.Slug != "ontario")
            {
               <div class="@(@region?.Slug != "ontario" ? "col-lg-3" : "col-lg-4") linkBlocks-item mb-2 mb-lg-0 mb-xl-0">
                    <a class="homepage-link-block bg-lighter d-block p-5 rounded-1 animate animate-icon-forward" href="/bonuses@(bonusesSlug)/">
                        <img loading="lazy" decoding="async" class="lazy" data-src="https://img.sportsbookreview.com/images/icons/campaign.svg" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="" width="64" height="64">
                        <h3 class="mt-4 d-flex justify-content-between align-items-end">Promos & <br class="d-sm-none d-md-none d-lg-block">Bonuses <span class="mat-icon-arrow-right-alt"></span></h3>
                    </a>
                </div>
            }
        </div>
    </div>

    <div id="banner" class="container mt-7">
        <div class="row">
            <div class="col-12">
                <div class="bg-bright_blue bg-pattern-sbr bg-pattern-mr bg-offset-2 p-5 rounded-1">
                    <div class="col-sm-8 col-md-6">
                        <h2 class="mb-3">Why Trust <span class="h3 d-block">Sportsbook Review?</span></h2>
                        <p>SBR is dedicated to providing players with an honest and unbiased approach to sports betting. Find out more about our processes for reviews, picks, and news.</p>
                        <a class="btn btn-secondary mt-5 mb-9 mb-lg-0 mb-xl-0 homepage-link-banner" href="/news/sbr-editorial-policy/">Learn more <span class="visually-hidden">about our editorial policy</span></a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mt-7">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <partial name="../Components/faqSection" model="homePage.Faqs" />
                </div>
            </div>
        </div>
    </div>

    @if (sportsbooks is not null)
    {
        <div id="compact-top-sportsbooks" class="container">
            @* Compact Sportsbook List *@
            <partial name="../Shared/Components/TopSportsbook/CompactSportsbookList" model="new ReusableTopListViewModel(compactToplistHeading, false, sportsbooks.Take(6).ToList())" />
        </div>        
    }

</div>

@section scripts {

     @if (ViewData["type"].ToString() == "slider")
    {
        <script defer src="@(config.Swiper.Url)npm/swiper@(config.Swiper.Version)/@(config.Swiper.File)"></script>
    }
    <environment names="Development">


        @if (ViewData["type"].ToString() == "slider")
        {
            <script src="~/js/swiper.js" type="module"></script>
        }
    </environment>
    <environment names="UAT,Staging,Production">
        @if (ViewData["type"].ToString() == "slider")
        {
            <script src="~/build/js/swiper.min.js" type="module" asp-append-version="true"></script>
        }
    </environment>
}
@section dnsprefetch {
    @if (ViewData["type"].ToString() == "slider")
    {
        <link crossorigin rel="preconnect dns-prefetch" href="@(config.Swiper.Url)">
    }
    @if (hero is not null && useHero == true)
    {
        if (srcLarge != "")
        {
            <link rel="preload" as="image" href="@srcLarge">
        }
        if (srcSmall != "")
        {
            <link rel="preload" as="image" href="@srcSmall">
        }
    }
}

